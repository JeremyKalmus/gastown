#!/bin/bash
# bd wrapper - Intercepts bd commands to invoke Gas Town plugin hooks
#
# This wraps the real bd binary to call plugin hooks like PostBeadCreate.
# Install via: keeper/install/setup.sh

set -euo pipefail

# Find the real bd binary (skip this wrapper)
SELF="$(realpath "${BASH_SOURCE[0]}" 2>/dev/null || readlink -f "${BASH_SOURCE[0]}" 2>/dev/null || echo "${BASH_SOURCE[0]}")"
BD_REAL=""

# Search for bd in PATH, skipping ourselves
IFS=':' read -ra PATH_DIRS <<< "$PATH"
for dir in "${PATH_DIRS[@]}"; do
    candidate="$dir/bd"
    if [[ -x "$candidate" ]] && [[ "$(realpath "$candidate" 2>/dev/null || echo "$candidate")" != "$SELF" ]]; then
        # Skip if it's a symlink to ourselves
        if [[ -L "$candidate" ]]; then
            target="$(readlink -f "$candidate" 2>/dev/null || readlink "$candidate")"
            [[ "$target" == "$SELF" ]] && continue
        fi
        BD_REAL="$candidate"
        break
    fi
done

# Fallback to homebrew location
if [[ -z "$BD_REAL" ]]; then
    BD_REAL=$(find /opt/homebrew/Cellar/bd -name "bd" -type f 2>/dev/null | head -1)
fi

if [[ -z "$BD_REAL" || ! -x "$BD_REAL" ]]; then
    echo "Error: Could not find real bd binary" >&2
    exit 1
fi

# Find Gas Town root (look for .gt directory or .beads)
find_town_root() {
    local dir="${1:-$(pwd)}"
    while [[ "$dir" != "/" ]]; do
        if [[ -d "$dir/.gt" ]] || [[ -d "$dir/.beads" && -f "$dir/.beads/routes.jsonl" ]]; then
            echo "$dir"
            return 0
        fi
        dir="$(dirname "$dir")"
    done
    # Check home directory
    if [[ -d "$HOME/gt/.gt" ]]; then
        echo "$HOME/gt"
        return 0
    fi
    return 1
}

GT_TOWN_ROOT="${GT_TOWN_ROOT:-$(find_town_root || echo "")}"

# If not a create command, pass through directly
if [[ "${1:-}" != "create" && "${1:-}" != "new" ]]; then
    exec "$BD_REAL" "$@"
fi

# Capture bd create output
OUTPUT=$("$BD_REAL" "$@" 2>&1) || {
    RC=$?
    echo "$OUTPUT"
    exit $RC
}
echo "$OUTPUT"

# If no town root, skip hooks
if [[ -z "$GT_TOWN_ROOT" ]]; then
    exit 0
fi

# Parse bead ID from output (looks for "Created ct-xxx" or similar)
BEAD_ID=$(echo "$OUTPUT" | grep -oE '\b[a-z]{2,3}-[a-z0-9]{3,6}\b' | head -1 || echo "")

if [[ -z "$BEAD_ID" ]]; then
    exit 0
fi

# Extract title from args
TITLE=""
TYPE="task"
DESC=""
ARGS=("$@")

i=0
while [[ $i -lt ${#ARGS[@]} ]]; do
    arg="${ARGS[$i]}"
    case "$arg" in
        create|new)
            ;;
        --title=*)
            TITLE="${arg#*=}"
            ;;
        --title)
            ((i++))
            TITLE="${ARGS[$i]:-}"
            ;;
        --type=*)
            TYPE="${arg#*=}"
            ;;
        --type)
            ((i++))
            TYPE="${ARGS[$i]:-task}"
            ;;
        --description=*|-d=*)
            DESC="${arg#*=}"
            ;;
        --description|-d)
            ((i++))
            DESC="${ARGS[$i]:-}"
            ;;
        -*)
            # Skip flags with values
            if [[ "$arg" != *"="* ]]; then
                next="${ARGS[$((i+1))]:-}"
                if [[ "${next:0:1}" != "-" && -n "$next" ]]; then
                    ((i++))
                fi
            fi
            ;;
        *)
            # Positional - likely title
            if [[ -z "$TITLE" ]]; then
                TITLE="$arg"
            fi
            ;;
    esac
    ((i++))
done

# Find keeper hook - check multiple locations
KEEPER_HOOK=""
for hook_path in \
    "${GT_TOWN_ROOT}/plugins/keeper/hooks/post-bead-create" \
    "${GT_TOWN_ROOT}/.gt/hooks/post-bd-create.sh" \
    "${HOME}/.keeper/hooks/post-bead-create"; do
    if [[ -x "$hook_path" ]]; then
        KEEPER_HOOK="$hook_path"
        break
    fi
done

if [[ -n "$KEEPER_HOOK" ]]; then
    # Find rig root from bead prefix
    PREFIX="${BEAD_ID%%-*}"
    GT_RIG_ROOT="$GT_TOWN_ROOT"

    ROUTES_FILE="${GT_TOWN_ROOT}/.beads/routes.jsonl"
    if [[ -f "$ROUTES_FILE" ]]; then
        RIG_PATH=$(grep "\"prefix\":\"${PREFIX}\"" "$ROUTES_FILE" 2>/dev/null | head -1 | sed 's/.*"path":"\([^"]*\)".*/\1/' || echo "")
        if [[ -n "$RIG_PATH" ]]; then
            GT_RIG_ROOT="${GT_TOWN_ROOT}/${RIG_PATH}"
        fi
    fi

    # Call keeper hook
    BD_BEAD_ID="$BEAD_ID" \
    BD_BEAD_TITLE="$TITLE" \
    BD_BEAD_DESCRIPTION="$DESC" \
    BD_BEAD_TYPE="$TYPE" \
    GT_TOWN_ROOT="$GT_TOWN_ROOT" \
    GT_RIG_ROOT="$GT_RIG_ROOT" \
    "$KEEPER_HOOK" 2>&1 || true
fi
